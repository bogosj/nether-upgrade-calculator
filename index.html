<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nether Resource Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="icon" type="image/png" href="favicon.png">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .custom-checkbox:checked {
            background-color: #4f46e5;
            border-color: #4f46e5;
        }
        .custom-checkbox:checked::after {
            content: '✔';
            color: white;
            display: block;
            text-align: center;
            line-height: 1.25rem;
            font-size: 0.8rem;
        }
        /* Hide number input arrows */
        input[type=number]::-webkit-inner-spin-button,
        input[type=number]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type=number] {
            -moz-appearance: textfield;
        }
    </style>
</head>
<body class="bg-gray-900 text-white antialiased">

    <div class="container mx-auto p-4 sm:p-6 lg:p-8 max-w-5xl">
        
        <!-- Header -->
        <header class="text-center mb-8">
            <h1 class="text-3xl sm:text-4xl font-bold text-indigo-400">Nether Resource Tracker</h1>
            <p class="text-gray-400 mt-2">Check off the upgrades you still need to calculate the total cost.</p>
        </header>

        <!-- Production & Spawning Section -->
        <div class="bg-gray-800 shadow-lg rounded-xl p-6 mb-8 border border-gray-700">
            <h2 class="text-xl font-semibold mb-4 text-white">Production & Spawning</h2>
            <div class="text-center">
                <div class="inline-grid grid-cols-1 sm:grid-cols-3 gap-6 mb-6 text-left">
                    <!-- Netherlings -->
                    <div class="bg-gray-700 p-4 rounded-lg">
                        <label for="flames-per-netherling" class="block text-sm font-medium text-gray-300 mb-2">Flames per Netherling</label>
                        <input type="number" id="flames-per-netherling" value="8" class="bg-gray-900 text-white w-full rounded-md p-2 text-center font-bold text-lg border border-gray-600 focus:ring-indigo-500 focus:border-indigo-500" placeholder="0" min="0">
                        <p class="text-xs text-gray-400 mt-2 text-center">Spawn Cost: 1 Orb</p>
                    </div>
                    <!-- Demons -->
                    <div class="bg-gray-700 p-4 rounded-lg">
                        <label for="crystals-per-demon" class="block text-sm font-medium text-gray-300 mb-2">Crystals per Demon</label>
                        <input type="number" id="crystals-per-demon" value="5" class="bg-gray-900 text-white w-full rounded-md p-2 text-center font-bold text-lg border border-gray-600 focus:ring-indigo-500 focus:border-indigo-500" placeholder="0" min="0">
                        <p class="text-xs text-gray-400 mt-2 text-center">Spawn Cost: 3 Orbs, 10 Flames</p>
                    </div>
                    <!-- Mountains -->
                    <div class="bg-gray-700 p-4 rounded-lg">
                        <label for="stars-per-mountain" class="block text-sm font-medium text-gray-300 mb-2">Stars per Mountain</label>
                        <input type="number" id="stars-per-mountain" value="3" class="bg-gray-900 text-white w-full rounded-md p-2 text-center font-bold text-lg border border-gray-600 focus:ring-indigo-500 focus:border-indigo-500" placeholder="0" min="0">
                        <p class="text-xs text-gray-400 mt-2 text-center">Spawn Cost: 12 Crystals</p>
                    </div>
                </div>
            </div>
            <h3 class="text-lg font-semibold mb-4 text-white">Total Spawn Cost:</h3>
             <div id="spawn-costs" class="grid grid-cols-2 sm:grid-cols-4 gap-4 text-center">
                <div class="bg-gray-700 p-4 rounded-lg">
                    <span class="text-2xl font-bold text-purple-400" id="spawn-cost-orbs">0</span>
                    <span class="block text-sm text-gray-300">Orbs</span>
                </div>
                <div class="bg-gray-700 p-4 rounded-lg">
                    <span class="text-2xl font-bold text-orange-400" id="spawn-cost-flames">0</span>
                    <span class="block text-sm text-gray-300">Flames</span>
                </div>
                <div class="bg-gray-700 p-4 rounded-lg">
                    <span class="text-2xl font-bold text-cyan-400" id="spawn-cost-crystals">0</span>
                    <span class="block text-sm text-gray-300">Crystals</span>
                </div>
                <div class="bg-gray-700 p-4 rounded-lg">
                    <span class="text-2xl font-bold text-yellow-400" id="spawn-cost-stars">0</span>
                    <span class="block text-sm text-gray-300">Stars</span>
                </div>
            </div>
        </div>

        <!-- Current Resources Section -->
        <div class="bg-gray-800 shadow-lg rounded-xl p-6 mb-8 border border-gray-700">
            <h2 class="text-xl font-semibold mb-4 text-white">Current Resources:</h2>
            <div id="current-resources" class="grid grid-cols-2 sm:grid-cols-4 gap-4">
                <div class="bg-gray-700 p-4 rounded-lg flex flex-col items-center">
                    <label for="current-orbs" class="block text-sm text-gray-300 mb-2">Orbs</label>
                    <input type="number" id="current-orbs" class="bg-gray-900 text-white w-full rounded-md p-2 text-center font-bold text-lg border border-gray-600 focus:ring-indigo-500 focus:border-indigo-500" placeholder="0" min="0">
                </div>
                <div class="bg-gray-700 p-4 rounded-lg flex flex-col items-center">
                     <label for="current-flames" class="block text-sm text-gray-300 mb-2">Flames</label>
                     <input type="number" id="current-flames" class="bg-gray-900 text-white w-full rounded-md p-2 text-center font-bold text-lg border border-gray-600 focus:ring-indigo-500 focus:border-indigo-500" placeholder="0" min="0">
                </div>
                <div class="bg-gray-700 p-4 rounded-lg flex flex-col items-center">
                     <label for="current-crystals" class="block text-sm text-gray-300 mb-2">Crystals</label>
                     <input type="number" id="current-crystals" class="bg-gray-900 text-white w-full rounded-md p-2 text-center font-bold text-lg border border-gray-600 focus:ring-indigo-500 focus:border-indigo-500" placeholder="0" min="0">
                </div>
                <div class="bg-gray-700 p-4 rounded-lg flex flex-col items-center">
                     <label for="current-stars" class="block text-sm text-gray-300 mb-2">Stars</label>
                     <input type="number" id="current-stars" class="bg-gray-900 text-white w-full rounded-md p-2 text-center font-bold text-lg border border-gray-600 focus:ring-indigo-500 focus:border-indigo-500" placeholder="0" min="0">
                </div>
            </div>
        </div>

        <!-- Totals Section -->
        <div class="bg-gray-800 shadow-lg rounded-xl p-6 mb-8 sticky top-4 z-10 border border-gray-700">
            <h2 class="text-xl font-semibold mb-4 text-white">Net Resources To Acquire</h2>
            <div id="totals" class="grid grid-cols-2 sm:grid-cols-4 gap-4 text-center">
                <div class="bg-gray-700 p-4 rounded-lg">
                    <span class="text-2xl font-bold text-purple-400" id="total-orbs">0</span>
                    <span class="block text-sm text-gray-300">Orbs</span>
                </div>
                <div class="bg-gray-700 p-4 rounded-lg">
                    <span class="text-2xl font-bold text-orange-400" id="total-flames">0</span>
                    <span class="block text-sm text-gray-300">Flames</span>
                </div>
                <div class="bg-gray-700 p-4 rounded-lg">
                    <span class="text-2xl font-bold text-cyan-400" id="total-crystals">0</span>
                    <span class="block text-sm text-gray-300">Crystals</span>
                </div>
                <div class="bg-gray-700 p-4 rounded-lg">
                    <span class="text-2xl font-bold text-yellow-400" id="total-stars">0</span>
                    <span class="block text-sm text-gray-300">Stars</span>
                </div>
            </div>
        </div>

        <!-- Upgrades List -->
        <main id="upgrades-container" class="space-y-6">
            <!-- Upgrade categories will be injected here by JavaScript -->
        </main>

        <!-- Strategy Section -->
        <div class="bg-gray-800 shadow-lg rounded-xl p-6 mt-8 border border-gray-700">
            <h2 class="text-xl font-semibold mb-4 text-white">Plan of Action</h2>
            <div id="strategy-summary-table" class="mb-6">
                <!-- Summary table will be injected here -->
            </div>
             <div id="strategy-spawning-table" class="mb-6">
                <!-- Spawning summary table will be injected here -->
            </div>
            <div id="strategy-text" class="text-gray-300 space-y-3 prose prose-invert max-w-none">
                <p>Select some upgrades and enter your production rates to see a step-by-step plan.</p>
            </div>
        </div>

    </div>

    <script>
        // Data for upgrades will be built here
        const upgradesData = [
            { id: 1, category: 'Netherling', name: 'Level 1', orbs: 5, needed: true },
            { id: 2, category: 'Netherling', name: 'Level 2', crystals: 10, needed: true },
            { id: 3, category: 'Netherling', name: 'Level 3', flames: 60, stars: 3, needed: true },
            { id: 4, category: 'Demon', name: 'Level 1', flames: 40, orbs: 10, needed: true },
            { id: 5, category: 'Demon', name: 'Level 2', stars: 4, needed: true },
            { id: 6, category: 'Demon', name: 'Level 3', crystals: 12, stars: 6, needed: true },
            { id: 7, category: 'Mountains', name: 'Level 1', crystals: 10, orbs: 15, needed: true },
            { id: 8, category: 'Mountains', name: 'Level 2', flames: 50, crystals: 20, needed: true },
            { id: 9, category: 'Scrolls', name: 'Nature', crystals: 15, needed: true },
            { id: 10, category: 'Scrolls', name: 'Plenty', flames: 50, crystals: 10, needed: true },
            { id: 11, category: 'Scrolls', name: 'Industry', flames: 75, crystals: 15, needed: true },
            { id: 12, category: 'Scrolls', name: 'Might', flames: 50, needed: true },
            { id: 13, category: 'Scrolls', name: 'Dark', crystals: 15, stars: 1, needed: true },
            { id: 14, category: 'Scrolls', name: 'Magic', flames: 75, needed: true },
            { id: 15, category: 'Scrolls', name: 'Unending', stars: 4, needed: true },
            { id: 16, category: 'Scrolls', name: 'Growth', flames: 25, stars: 6, needed: true },
            { id: 17, category: 'Scrolls', name: 'Dead', flames: 25, needed: true },
            { id: 18, category: 'Scrolls', name: 'Troll', flames: 20, crystals: 5, needed: true },
            { id: 19, category: 'Scrolls', name: 'Scales', crystals: 10, stars: 2, needed: true },
            { id: 20, category: 'Scrolls', name: 'Time', flames: 35, needed: true },
            { id: 21, category: 'Scrolls', name: 'Nether', flames: 50, crystals: 10, needed: true },
            { id: 22, category: 'DDD', name: 'Level 7', flames: 150, crystals: 25, needed: true },
            { id: 23, category: 'DDD', name: 'Level 8', crystals: 50, stars: 25, needed: true },
            { id: 24, category: 'DDD', name: 'Level 10', stars: 50, needed: true }
        ];

        document.addEventListener('DOMContentLoaded', () => {
            const upgradesContainer = document.getElementById('upgrades-container');
            const strategySummaryTableEl = document.getElementById('strategy-summary-table');
            const strategySpawningTableEl = document.getElementById('strategy-spawning-table');
            const strategyTextEl = document.getElementById('strategy-text');

            // Total Needed Elements
            const totalsOrbsEl = document.getElementById('total-orbs');
            const totalsFlamesEl = document.getElementById('total-flames');
            const totalsCrystalsEl = document.getElementById('total-crystals');
            const totalsStarsEl = document.getElementById('total-stars');

            // Current Resources Inputs
            const currentOrbsInput = document.getElementById('current-orbs');
            const currentFlamesInput = document.getElementById('current-flames');
            const currentCrystalsInput = document.getElementById('current-crystals');
            const currentStarsInput = document.getElementById('current-stars');
            
            // Production Inputs
            const flamesPerNetherlingInput = document.getElementById('flames-per-netherling');
            const crystalsPerDemonInput = document.getElementById('crystals-per-demon');
            const starsPerMountainInput = document.getElementById('stars-per-mountain');

            // Spawn Cost Elements
            const spawnCostOrbsEl = document.getElementById('spawn-cost-orbs');
            const spawnCostFlamesEl = document.getElementById('spawn-cost-flames');
            const spawnCostCrystalsEl = document.getElementById('spawn-cost-crystals');
            const spawnCostStarsEl = document.getElementById('spawn-cost-stars');
            
            function calculateTotals() {
                // 1. Get gross upgrade costs from checked items
                const grossTotals = upgradesData.reduce((acc, upgrade) => {
                    if (upgrade.needed) {
                        acc.orbs += upgrade.orbs || 0;
                        acc.flames += upgrade.flames || 0;
                        acc.crystals += upgrade.crystals || 0;
                        acc.stars += upgrade.stars || 0;
                    }
                    return acc;
                }, { flames: 0, crystals: 0, stars: 0, orbs: 0 });

                // 2. Get current inventory and production rates
                const currentResources = {
                    orbs: parseInt(currentOrbsInput.value) || 0,
                    flames: parseInt(currentFlamesInput.value) || 0,
                    crystals: parseInt(currentCrystalsInput.value) || 0,
                    stars: parseInt(currentStarsInput.value) || 0,
                };
                const flamesPerNetherling = parseInt(flamesPerNetherlingInput.value) || 0;
                const crystalsPerDemon = parseInt(crystalsPerDemonInput.value) || 0;
                const starsPerMountain = parseInt(starsPerMountainInput.value) || 0;

                // 3. --- Start backward calculation from STARS ---
                const netStarsNeeded = Math.max(0, grossTotals.stars - currentResources.stars);
                const mountainsToSpawn = (starsPerMountain > 0 && netStarsNeeded > 0) ? Math.ceil(netStarsNeeded / starsPerMountain) : 0;
                const crystalCostForMountains = mountainsToSpawn * 12;

                // 4. --- Calculate CRYSTALS ---
                const totalCrystalDemand = grossTotals.crystals + crystalCostForMountains;
                const netCrystalsNeeded = Math.max(0, totalCrystalDemand - currentResources.crystals);
                const demonsToSpawn = (crystalsPerDemon > 0 && netCrystalsNeeded > 0) ? Math.ceil(netCrystalsNeeded / crystalsPerDemon) : 0;
                const flameCostForDemons = demonsToSpawn * 10;
                const orbCostForDemons = demonsToSpawn * 3;

                // 5. --- Calculate FLAMES ---
                const totalFlameDemand = grossTotals.flames + flameCostForDemons;
                const netFlamesNeeded = Math.max(0, totalFlameDemand - currentResources.flames);
                const netherlingsToSpawn = (flamesPerNetherling > 0 && netFlamesNeeded > 0) ? Math.ceil(netFlamesNeeded / flamesPerNetherling) : 0;
                const orbCostForNetherlings = netherlingsToSpawn * 1;

                // 6. --- Calculate ORBS ---
                const totalOrbDemand = grossTotals.orbs + orbCostForDemons + orbCostForNetherlings;
                const netOrbsNeeded = Math.max(0, totalOrbDemand - currentResources.orbs);
                
                // 7. --- Update UI ---
                
                // Final deficit display
                totalsOrbsEl.textContent = netOrbsNeeded.toLocaleString();
                totalsFlamesEl.textContent = netFlamesNeeded.toLocaleString();
                totalsCrystalsEl.textContent = netCrystalsNeeded.toLocaleString();
                totalsStarsEl.textContent = netStarsNeeded.toLocaleString();

                // Spawn cost display
                const totalSpawnCostOrbs = orbCostForDemons + orbCostForNetherlings;
                spawnCostOrbsEl.textContent = totalSpawnCostOrbs.toLocaleString();
                spawnCostFlamesEl.textContent = flameCostForDemons.toLocaleString();
                spawnCostCrystalsEl.textContent = crystalCostForMountains.toLocaleString();
                spawnCostStarsEl.textContent = '0';

                // --- PLAN OF ACTION ---
                const neededUpgrades = upgradesData.filter(u => u.needed);
                if (neededUpgrades.length === 0) {
                    strategySummaryTableEl.innerHTML = '';
                    strategySpawningTableEl.innerHTML = '';
                    strategyTextEl.innerHTML = '<p>Select some upgrades to get started.</p>';
                    return;
                }

                // Build Summary Table
                let upgradeTableRows = neededUpgrades.map(u => `
                    <tr class="border-b border-gray-700 hover:bg-gray-600">
                        <th scope="row" class="px-4 py-3 font-medium text-gray-200 whitespace-nowrap">${u.category} - ${u.name}</th>
                        <td class="px-4 py-3 text-purple-400">${u.orbs?.toLocaleString() || '0'}</td>
                        <td class="px-4 py-3 text-orange-400">${u.flames?.toLocaleString() || '0'}</td>
                        <td class="px-4 py-3 text-cyan-400">${u.crystals?.toLocaleString() || '0'}</td>
                        <td class="px-4 py-3 text-yellow-400">${u.stars?.toLocaleString() || '0'}</td>
                    </tr>
                `).join('');

                const summaryTableHtml = `
                    <h3 class="text-lg font-semibold mb-4 text-white">Selected Upgrade Costs Summary</h3>
                    <div class="overflow-x-auto relative rounded-lg border border-gray-700">
                        <table class="w-full text-sm text-left text-gray-400">
                            <thead class="text-xs text-gray-300 uppercase bg-gray-700">
                                <tr>
                                    <th scope="col" class="px-4 py-3">Upgrade</th>
                                    <th scope="col" class="px-4 py-3">Orbs</th>
                                    <th scope="col" class="px-4 py-3">Flames</th>
                                    <th scope="col" class="px-4 py-3">Crystals</th>
                                    <th scope="col" class="px-4 py-3">Stars</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${upgradeTableRows}
                            </tbody>
                            <tfoot class="font-semibold text-gray-200 bg-gray-700">
                                <tr>
                                    <th scope="row" class="px-4 py-3 text-base">Total Direct Cost</th>
                                    <td class="px-4 py-3 text-purple-400">${grossTotals.orbs.toLocaleString()}</td>
                                    <td class="px-4 py-3 text-orange-400">${grossTotals.flames.toLocaleString()}</td>
                                    <td class="px-4 py-3 text-cyan-400">${grossTotals.crystals.toLocaleString()}</td>
                                    <td class="px-4 py-3 text-yellow-400">${grossTotals.stars.toLocaleString()}</td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                `;
                strategySummaryTableEl.innerHTML = summaryTableHtml;

                // Build Spawning Table
                const totalSpawns = netherlingsToSpawn + demonsToSpawn + mountainsToSpawn;
                if (totalSpawns > 0) {
                     const spawningTableHtml = `
                        <h3 class="text-lg font-semibold mb-4 text-white">Spawning Costs Summary</h3>
                        <div class="overflow-x-auto relative rounded-lg border border-gray-700">
                            <table class="w-full text-sm text-left text-gray-400">
                                <thead class="text-xs text-gray-300 uppercase bg-gray-700">
                                    <tr>
                                        <th scope="col" class="px-4 py-3">Creature</th>
                                        <th scope="col" class="px-4 py-3">To Spawn</th>
                                        <th scope="col" class="px-4 py-3">Orbs Cost</th>
                                        <th scope="col" class="px-4 py-3">Flames Cost</th>
                                        <th scope="col" class="px-4 py-3">Crystals Cost</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${netherlingsToSpawn > 0 ? `<tr class="border-b border-gray-700">
                                        <th scope="row" class="px-4 py-3 font-medium text-gray-200">Netherlings</th>
                                        <td class="px-4 py-3">${netherlingsToSpawn.toLocaleString()}</td>
                                        <td class="px-4 py-3 text-purple-400">${orbCostForNetherlings.toLocaleString()}</td>
                                        <td class="px-4 py-3 text-orange-400">0</td>
                                        <td class="px-4 py-3 text-cyan-400">0</td>
                                    </tr>` : ''}
                                     ${demonsToSpawn > 0 ? `<tr class="border-b border-gray-700">
                                        <th scope="row" class="px-4 py-3 font-medium text-gray-200">Demons</th>
                                        <td class="px-4 py-3">${demonsToSpawn.toLocaleString()}</td>
                                        <td class="px-4 py-3 text-purple-400">${orbCostForDemons.toLocaleString()}</td>
                                        <td class="px-4 py-3 text-orange-400">${flameCostForDemons.toLocaleString()}</td>
                                        <td class="px-4 py-3 text-cyan-400">0</td>
                                    </tr>` : ''}
                                     ${mountainsToSpawn > 0 ? `<tr class="border-b border-gray-700">
                                        <th scope="row" class="px-4 py-3 font-medium text-gray-200">Mountains</th>
                                        <td class="px-4 py-3">${mountainsToSpawn.toLocaleString()}</td>
                                        <td class="px-4 py-3 text-purple-400">0</td>
                                        <td class="px-4 py-3 text-orange-400">0</td>
                                        <td class="px-4 py-3 text-cyan-400">${crystalCostForMountains.toLocaleString()}</td>
                                    </tr>` : ''}
                                </tbody>
                                <tfoot class="font-semibold text-gray-200 bg-gray-700">
                                    <tr>
                                        <th scope="row" class="px-4 py-3 text-base">Total Spawn Cost</th>
                                        <td class="px-4 py-3"></td>
                                        <td class="px-4 py-3 text-purple-400">${totalSpawnCostOrbs.toLocaleString()}</td>
                                        <td class="px-4 py-3 text-orange-400">${flameCostForDemons.toLocaleString()}</td>
                                        <td class="px-4 py-3 text-cyan-400">${crystalCostForMountains.toLocaleString()}</td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                    `;
                    strategySpawningTableEl.innerHTML = spawningTableHtml;
                } else {
                    strategySpawningTableEl.innerHTML = '';
                }


                // Build Written Plan
                let steps = [];
                const hasNeeds = grossTotals.flames || grossTotals.crystals || grossTotals.stars || grossTotals.orbs;
                
                // Step 1: Orbs (Foundation)
                if (totalOrbDemand > 0) {
                     if (netOrbsNeeded > 0) {
                        steps.push(`<p><strong class="text-base text-indigo-300 block mb-1">Step 1: The Orb Shortage</strong>The entire plan requires a total of <strong class="text-purple-400">${totalOrbDemand.toLocaleString()} orbs</strong> for both direct upgrades and all spawning activities. After using your current ${currentResources.orbs.toLocaleString()}, you have a fundamental shortage of <strong class="text-purple-400">${netOrbsNeeded.toLocaleString()} orbs</strong> that must be acquired first.</p>`);
                     } else {
                        steps.push(`<p><strong class="text-base text-indigo-300 block mb-1">Step 1: Orbs Check</strong>Your total orb demand of <strong class="text-purple-400">${totalOrbDemand.toLocaleString()}</strong> is covered by your current inventory. No orb acquisition is needed.</p>`);
                     }
                }

                // Step 2: Flames
                if (flamesPerNetherling <= 0 && netFlamesNeeded > 0) {
                    steps.push(`<p class="text-red-400"><strong class="text-base text-indigo-300 block mb-1">Step 2: Generate Flames</strong>You need a total of ${netFlamesNeeded.toLocaleString()} 🔥, but can't produce them. Enter a value for 'Flames per Netherling'.</p>`);
                } else if (netherlingsToSpawn > 0) {
                    let flameReasoning = `${grossTotals.flames.toLocaleString()} for upgrades`;
                    if (flameCostForDemons > 0) {
                        flameReasoning += `, and ${flameCostForDemons.toLocaleString()} to spawn Demons`;
                    }
                    steps.push(`<p><strong class="text-base text-indigo-300 block mb-1">Step 2: Generate Flames</strong>Your total demand for flames is <strong class="text-orange-400">${totalFlameDemand.toLocaleString()}</strong> (${flameReasoning}). After using your current ${currentResources.flames.toLocaleString()}, you need <strong class="text-orange-400">${netFlamesNeeded.toLocaleString()} more</strong>. To get them, you must spawn ~<strong>${netherlingsToSpawn.toLocaleString()} Netherlings</strong>, which will cost <strong class="text-purple-400">${orbCostForNetherlings.toLocaleString()} orbs</strong>.</p>`);
                } else {
                     steps.push(`<p><strong class="text-base text-indigo-300 block mb-1">Step 2: Generate Flames</strong>Your total flame demand of <strong class="text-orange-400">${totalFlameDemand.toLocaleString()}</strong> is covered by your current inventory. No Netherling spawning is needed.</p>`);
                }

                // Step 3: Crystals
                if (crystalsPerDemon <= 0 && netCrystalsNeeded > 0) {
                    steps.push(`<p class="text-red-400"><strong class="text-base text-indigo-300 block mb-1">Step 3: Generate Crystals</strong>You need a total of ${netCrystalsNeeded.toLocaleString()} 💎, but can't produce them. Enter a value for 'Crystals per Demon'.</p>`);
                } else if (demonsToSpawn > 0) {
                    let crystalReasoning = `${grossTotals.crystals.toLocaleString()} for upgrades`;
                    if (crystalCostForMountains > 0) {
                        crystalReasoning += `, and ${crystalCostForMountains.toLocaleString()} to spawn Mountains`;
                    }
                    steps.push(`<p><strong class="text-base text-indigo-300 block mb-1">Step 3: Generate Crystals</strong>Your total demand for crystals is <strong class="text-cyan-400">${totalCrystalDemand.toLocaleString()}</strong> (${crystalReasoning}). After using your current ${currentResources.crystals.toLocaleString()}, you need <strong class="text-cyan-400">${netCrystalsNeeded.toLocaleString()} more</strong>. You'll need to spawn ~<strong>${demonsToSpawn.toLocaleString()} Demons</strong>, which will cost <strong class="text-orange-400">${flameCostForDemons.toLocaleString()} flames</strong> and <strong class="text-purple-400">${orbCostForDemons.toLocaleString()} orbs</strong>.</p>`);
                } else {
                     steps.push(`<p><strong class="text-base text-indigo-300 block mb-1">Step 3: Generate Crystals</strong>Your total crystal demand of <strong class="text-cyan-400">${totalCrystalDemand.toLocaleString()}</strong> is covered by your current inventory. No Demon spawning is needed.</p>`);
                }

                // Step 4: Stars
                if (starsPerMountain <= 0 && netStarsNeeded > 0) {
                    steps.push(`<p class="text-red-400"><strong class="text-base text-indigo-300 block mb-1">Step 4: Generate Stars</strong>You need ${netStarsNeeded.toLocaleString()} ⭐, but can't produce them. Enter a value for 'Stars per Mountain'.</p>`);
                } else if (mountainsToSpawn > 0) {
                     steps.push(`<p><strong class="text-base text-indigo-300 block mb-1">Step 4: Generate Stars</strong>Finally, your upgrades require <strong class="text-yellow-400">${grossTotals.stars.toLocaleString()} stars</strong>. After using your current ${currentResources.stars.toLocaleString()}, you still need <strong class="text-yellow-400">${netStarsNeeded.toLocaleString()} more</strong>. To produce these, spawn approximately <strong>${mountainsToSpawn.toLocaleString()} Mountains</strong> at a cost of <strong class="text-cyan-400">${crystalCostForMountains.toLocaleString()} crystals</strong>.</p>`);
                } else {
                    steps.push(`<p><strong class="text-base text-indigo-300 block mb-1">Step 4: Generate Stars</strong>Your upgrades require <strong class="text-yellow-400">${grossTotals.stars.toLocaleString()} stars</strong>. Your current inventory of ${currentResources.stars.toLocaleString()} is sufficient to cover this cost. No Mountain spawning is needed.</p>`)
                }

                if(steps.length > 0) {
                    strategyTextEl.innerHTML = `<h3 class="text-lg font-semibold mb-4 text-white">Execution Steps</h3>` + steps.join('');
                } else if (hasNeeds) {
                     strategyTextEl.innerHTML = '<h3 class="text-lg font-semibold mb-4 text-white">Execution Steps</h3><p>You have everything you need for the selected upgrades!</p>';
                }

            }

            function renderUpgrades() {
                // Group upgrades by category
                const groupedUpgrades = upgradesData.reduce((acc, upgrade) => {
                    if (!acc[upgrade.category]) {
                        acc[upgrade.category] = [];
                    }
                    acc[upgrade.category].push(upgrade);
                    return acc;
                }, {});

                upgradesContainer.innerHTML = ''; // Clear existing content

                for (const category in groupedUpgrades) {
                    const categoryContainer = document.createElement('div');
                    categoryContainer.className = 'bg-gray-800 shadow-lg rounded-xl border border-gray-700';
                    
                    const categoryHeader = document.createElement('h3');
                    categoryHeader.className = 'text-lg font-semibold text-indigo-300 p-4 border-b border-gray-700';
                    categoryHeader.textContent = category;
                    categoryContainer.appendChild(categoryHeader);

                    const list = document.createElement('ul');
                    list.className = 'divide-y divide-gray-700';
                    
                    groupedUpgrades[category].forEach(upgrade => {
                        const item = document.createElement('li');
                        item.className = 'flex items-center justify-between p-4 flex-wrap';
                        
                        item.innerHTML = `
                            <div class="flex items-center mb-2 sm:mb-0">
                                <input type="checkbox" id="upgrade-${upgrade.id}" data-id="${upgrade.id}" class="custom-checkbox appearance-none w-5 h-5 rounded border-2 border-gray-500 bg-gray-600 transition-all duration-200 cursor-pointer" ${upgrade.needed ? 'checked' : ''}>
                                <label for="upgrade-${upgrade.id}" class="ml-4 text-gray-200 cursor-pointer">${upgrade.name}</label>
                            </div>
                            <div class="flex items-center space-x-4 text-sm w-full sm:w-auto justify-end">
                                ${upgrade.orbs ? `<span class="text-purple-400 font-medium">${upgrade.orbs.toLocaleString()} 🔮</span>` : ''}
                                ${upgrade.flames ? `<span class="text-orange-400 font-medium">${upgrade.flames.toLocaleString()} 🔥</span>` : ''}
                                ${upgrade.crystals ? `<span class="text-cyan-400 font-medium">${upgrade.crystals.toLocaleString()} 💎</span>` : ''}
                                ${upgrade.stars ? `<span class="text-yellow-400 font-medium">${upgrade.stars.toLocaleString()} ⭐</span>` : ''}
                            </div>
                        `;
                        list.appendChild(item);
                    });

                    categoryContainer.appendChild(list);
                    upgradesContainer.appendChild(categoryContainer);
                }
            }
            
            upgradesContainer.addEventListener('change', (e) => {
                if (e.target.type === 'checkbox') {
                    const upgradeId = parseInt(e.target.dataset.id);
                    const upgrade = upgradesData.find(u => u.id === upgradeId);
                    if (upgrade) {
                        upgrade.needed = e.target.checked;
                        calculateTotals();
                    }
                }
            });

            const allInputs = [
                currentOrbsInput, currentFlamesInput, currentCrystalsInput, currentStarsInput,
                flamesPerNetherlingInput, crystalsPerDemonInput, starsPerMountainInput
            ];

            allInputs.forEach(input => {
                input.addEventListener('input', calculateTotals);
            });

            // Initial setup
            renderUpgrades();
            calculateTotals();
        });
    </script>
</body>
</html>

